###########################################################################
#####    Define Independent Loci for meta-analysis eGFR GWAS          #####
#####    Meta-analysis eGFR GWAS in this study (n=1,454,395)          #####
#####    Based on significant associations with p < 5E-8              #####
###########################################################################
##### Step1: Identify significant associations with p < 5E-8
awk '{if($10 == "P.value" || $10 < 5e-8) print $0}' Meta.eGFR.GWAS.CKDGen.UKB.MVP.PAGE.SUMMIT.2Study.autosome.MAF0.001.txt > Meta.eGFR.GWAS.CKDGen.UKB.MVP.PAGE.SUMMIT.2Study.autosome.MAF0.001.Sig5e8.txt
# 79693 Meta.eGFR.GWAS.CKDGen.UKB.MVP.PAGE.SUMMIT.2Study.autosome.MAF0.001.Sig5e8.txt

###########################################################################
##### Step2: Remove variants localized in MHC region (chr6:25-35Mb)
head -n 1 Meta.eGFR.GWAS.CKDGen.UKB.MVP.PAGE.SUMMIT.2Study.autosome.MAF0.001.Sig5e8.txt > Meta.eGFR.GWAS.CKDGen.UKB.MVP.PAGE.SUMMIT.2Study.autosome.MAF0.001.Sig5e8.NoMHC.txt
cat Meta.eGFR.GWAS.CKDGen.UKB.MVP.PAGE.SUMMIT.2Study.autosome.MAF0.001.Sig5e8.txt | awk 'NR >1 {if (!(($2 == 6) && ($3 > 25000000) && ($3 < 35000000))) print $0}' \
>> Meta.eGFR.GWAS.CKDGen.UKB.MVP.PAGE.SUMMIT.2Study.autosome.MAF0.001.Sig5e8.NoMHC.txt
wc -l Meta.eGFR.GWAS.CKDGen.UKB.MVP.PAGE.SUMMIT.2Study.autosome.MAF0.001.Sig5e8.NoMHC.txt
# 72712 Meta.eGFR.GWAS.CKDGen.UKB.MVP.PAGE.SUMMIT.2Study.autosome.MAF0.001.Sig5e8.NoMHC.txt


###########################################################################
##### Step3: Clumping using Plink with reference panel (1000 genome EUR)
echo SNP$'\t'P > Meta_eGFR_GWAS_LeadSNP.NoMHC.forPlinkClumping.txt
awk 'NR>1{print $2":"$3"\t"$11}' Meta.eGFR.GWAS.CKDGen.UKB.MVP.PAGE.SUMMIT.2Study.autosome.MAF0.001.Sig5e8.NoMHC.txt \
>> Meta_eGFR_GWAS_LeadSNP.NoMHC.forPlinkClumping.txt

plink --file reduced.ALL.phase3_shapeit2_mvncall_integrated_v5.20130502.genotypes.EUR.rmdup \
--clump Meta_eGFR_GWAS_LeadSNP.NoMHC.forPlinkClumping.txt \
--clump-p1 5e-8 --clump-r2 0.1 --clump-kb 10000 \
--out Meta_eGFR_GWAS_LeadSNP.NoMHC.PlinkClumping.p5e8.r20.1.1Mb

### Format and extract first and last significant 
echo CHR$'\t'POS$'\t'SNP$'\t'P$'\t'Left$'\t'Right > Meta_eGFR_GWAS_LeadSNP.NoMHC.PlinkClumping.p5e8.r20.1.1Mb.clumped.formatted
awk 'NR>1{print $3"\t"$5"\t"$12}' Meta_eGFR_GWAS_LeadSNP.NoMHC.PlinkClumping.p5e8.r20.1.1Mb.clumped | sed 's/(1)//g' | sed 's/NONE//g' | awk -F',' '{print $1"\t"$NF}' | sed 's/:/\t/g' |\
awk '{if($1 >0) print $1"\t"$2"\t"$1":"$2"\t"$3"\t"$5"\t"$7}' >> Meta_eGFR_GWAS_LeadSNP.NoMHC.PlinkClumping.p5e8.r20.1.1Mb.clumped.formatted
#    1311 Meta_eGFR_GWAS_LeadSNP.NoMHC.PlinkClumping.p5e8.r20.1.1Mb.clumped.formatted

### Obtained clumped variants for each lead variant
awk 'NR>1{print $3"\t"$5"\t"$12}' Meta_eGFR_GWAS_LeadSNP.NoMHC.PlinkClumping.p5e8.r20.1.1Mb.clumped | sed 's/(1)//g' | sed 's/NONE//g' | awk '{print $1"\t"$3}' > Meta_eGFR_GWAS_LeadSNP.NoMHC.PlinkClumping.p5e8.r20.1.1Mb.clumped.pairs.txt
cd ./Pairs/
awk '{print > $1}' ../Meta_eGFR_GWAS_LeadSNP.NoMHC.PlinkClumping.p5e8.r20.1.1Mb.clumped.pairs.txt 
ChrNumList=(10:101619779 11:16248020 12:3332691 14:50856641 15:45763486 15:99274326 17:17587395 18:77236974 1:150880180 1:43704656 20:8315317 2:176780507 2:28350375 3:170670822 4:77392924 5:53215813 6:20404420 7:151441347 8:32465751 10:101764013 11:17027555 12:3341040 14:54418411 15:45768522 16:16127916 17:19289286 18:77242300 1:150935317 1:46039077 21:16576783 2:176887691 2:28421461 3:183375992 4:77397585 5:53259682 6:20428432 7:151443931 8:32525041 10:104201598 11:2086132 12:3356086 14:54693851 15:45779810 16:2003425 17:19408607 18:77755179 1:151046455 1:47969863 21:16793890 2:176950926 2:32659850 3:185354216 4:77400728 5:53271420 6:21150457 7:151465390 8:49555905 10:104403310 11:2167850 12:337395 14:68082337 15:45784009 16:2025604 17:19437187 19:1169384 1:155026114 1:48002447 21:35273508 2:176974104 2:32919113 3:185457715 4:77410318 5:53298716 6:24310319 7:155597936 8:6379832 10:104434194 11:2178330 12:3387697 14:68676778 15:45799697 16:20314606 17:19486592 19:1238322 1:155099852 1:53581670 21:35356706 2:176993583 2:40680149 3:185550317 4:77423228 5:53372126 6:24360230 7:155619498 8:66567648 10:104515069 11:2648726 12:3390804 14:69158128 15:45821123 16:20316843 17:1967501 19:13022859 1:155157715 1:55718708 21:35356814 2:177277284 2:43421461 3:185818559 4:77425317 5:53373535 6:2503335 7:155656235 8:72649827 10:104575870 11:2755346 12:3411128 14:73244469 15:45834506 16:20339379 17:29720140 19:14175226 1:155161794 1:56612978 21:35359515 2:177338441 2:43464818 3:186433932 4:77436991 5:53529659 6:41662890 7:155665959 8:76475304 10:105215651 11:2779194 12:355842 14:73356307 15:45895020 16:20347156 17:34882998 19:14588476 1:155268131 1:56729866 21:37800740 2:177616844 2:43807368 3:193811168 4:77463809 5:53585870 6:41673580 7:155671059 8:8122420 10:1138802 11:2798804 12:356182 14:73884540 15:45938661 16:20350242 17:37070994 19:18203841 1:155885112 1:56767613 21:37834641 2:177691543 2:44390369 3:195614722 4:77465761 5:622004 6:41681622 7:155744252 8:8289899 10:1156815 11:2809196 12:4495864 14:74061242 15:45943716 16:20352313 17:37349710 19:18280096 1:156202640 1:56932262 22:24151583 2:177920565 2:45985859 3:195635432 4:77523809 5:67687659 6:41702227 7:156125204 8:8349138 10:120248713 11:2926094 12:4521511 14:74092088 15:45948384 16:20375571 17:37378538 19:18384544 1:156434703 1:61680266 22:28186370 2:177948254 2:46537056 3:196949870 4:77697071 5:676962 6:41967501 7:156266712 8:8502230 10:1205839 11:2949861 12:4546565 14:74234294 15:45951409 16:20386162 17:37424070 19:18575193 1:15911349 1:62920008 22:30124968 2:178125142 2:54513742 3:25424929 4:77711284 5:67714246 6:43354431 7:156271769 8:8538009 10:124139910 11:30571347 12:4588230 14:80604864 15:45951471 16:20390734 17:37430358 19:18843752 1:16101938 1:66168566 22:30359410 2:178322024 2:54581356 3:30753573 4:81182554 5:67750213 6:43389045 7:156297949 8:8612786 10:126396511 11:30605859 12:484772 14:81791046 15:45969171 16:20392332 17:37461149 19:19578743 1:16275506 1:67500762 22:30950360 2:179681330 2:54870908 3:38529440 4:90278279 5:67802330 6:43520359 7:156420523 8:86396656 10:126552236 11:30643977 12:48740855 14:81870100 15:45972166 16:20407525 17:37532579 19:21762189 1:163739717 1:68009663 22:31759187 2:182992435 2:55009201 3:39195260 4:95521086 5:68029078 6:43666837 7:17287106 8:8659454 10:126623542 11:30685335 12:49216201 14:85295248 15:45972336 16:20408696 17:37551988 19:33116498 1:16555105 1:77971205 22:36548406 2:183077254 2:64888426 3:48443816 4:971266 5:68043894 6:43798902 7:17458747 8:87332545 10:1283195 11:30730098 12:49478658 14:85994068 15:46026545 16:20414772 17:37779007 19:33322086 1:170649277 1:78649783 22:38601231 2:183201716 2:66668309 3:48769855 4:9918492 5:68253952 6:43800943 7:25791691 8:8907294 10:131445027 11:30739686 12:50267335 14:88874915 15:46051922 16:20432545 17:37927120 19:33342977 1:171451621 1:82956250 22:40412001 2:183282753 2:66750017 3:49441091 5:107407975 5:68656327 6:43805362 7:26577894 8:8997207 10:16874242 11:30749090 12:51208764 14:93108131 15:46280589 16:20436287 17:37992281 19:33346341 1:171478706 1:86120024 22:40516522 2:18676276 2:71106033 3:51689306 5:1183560 5:698650 6:43813341 7:27238287 8:9104692 10:29719872 11:30749169 12:52314388 14:93406702 15:53901935 16:20446377 17:38085385 19:33346402 1:171482616 1:8726721 22:40652924 2:18704681 2:73384632 3:52556369 5:131340702 5:78326213 6:44030011 7:32940086 8:9154063 10:29781798 11:30749646 12:52343370 14:93570702 15:53969364 16:20471192 17:38110575 19:33346430 1:172155751 1:89381949 22:40697589 2:187933972 2:73542784 3:52852897 5:131732774 5:90213250 6:44765535 7:33071205 8:9155582 10:35037042 11:30759939 12:53367911 14:93609385 15:54049504 16:20569372 17:38164135 19:33364389 1:172333248 1:94057720 22:40814636 2:188168567 2:73652316 3:58327899 5:131777682 5:90417593 6:46788191 7:41016442 8:9173358 10:50852527 11:30807171 12:539984 14:93775028 15:57729289 16:2068770 17:40492887 19:33396382 1:180905694 1:94890418 22:40884662 2:208481755 2:73808307 3:63962678 5:132210674 5:90609009 6:50885608 7:41046432 8:9183102 10:50959682 11:31000059 12:54009977 14:96664898 15:57766915 16:20854647 17:43337970 19:33402419 1:183049792 20:1333060 22:41039753 2:210848110 2:73871689 3:69145632 5:132397351 5:97906471 6:51382261 7:46753684 8:9202042 10:51006038 11:31364101 12:557254 14:99750386 15:57779337 16:21054290 17:44975083 19:33428166 1:184865132 20:1388219 22:42403446 2:211346921 2:73876623 3:69774171 5:148542406 6:100894587 6:51492862 7:50751250 8:9307214 10:52133698 11:47427667 12:56863770 15:39231774 15:57793765 16:21163517 17:45008935 19:33486803 1:184964347 20:14677788 22:42545221 2:211403117 2:74104872 3:69805616 5:175746402 6:107172979 6:51703012 7:50770629 8:95686850 10:52459323 11:48091032 12:57826982 15:39288527 15:57830151 16:2161796 17:46213674 19:33507781 1:185128250 20:2799897 22:43079607 2:211525913 3:105455955 3:73113528 5:176393447 6:108962642 6:52050063 7:56139179 8:95908067 10:52645248 11:48250764 12:65965572 15:40886841 15:57856802 16:2569810 17:46242955 19:36343079 1:185359714 20:31225069 22:43112961 2:211539983 3:121635230 3:99477142 5:176463651 6:109015426 6:52630153 7:650298 8:9676693 10:63725862 11:5485292 12:66317487 15:41057507 15:62806134 16:28917644 17:54666735 19:37799536 1:186582662 20:3223212 22:50795620 2:211543055 3:121899848 4:10115065 5:176572625 6:109036081 6:52701557 7:65374027 9:103341081 10:63795446 11:5578429 12:67667882 15:41208890 15:62894319 16:3588068 17:54776955 19:37906510 1:186802221 20:32302908 22:50886220 2:211589743 3:12218523 4:1019312 5:176676303 6:116363149 6:54186147 7:75612803 9:112223084 10:63814914 11:57409538 12:69792610 15:41399951 15:63356721 16:3710537 17:55776915 19:37942121 1:1873514 20:32737042 2:101605057 2:211596440 3:122228974 4:103554821 5:176676897 6:126221008 6:55422618 7:77143217 9:116300936 10:65191645 11:65143892 12:76271183 15:41501483 15:63580155 16:51165628 17:56797503 19:38188233 1:18809916 20:32774089 2:102991369 2:211608006 3:12301166 4:103732866 5:176680269 6:130374461 6:55644601 7:77297890 9:116853660 10:69563811 11:65228278 12:82264101 15:41725023 15:65734856 16:51205819 17:58691523 19:38397671 1:18810349 20:33205011 2:103155075 2:211627384 3:125104616 4:106099809 5:176726659 6:131148486 6:6682662 7:77515422 9:119140488 10:69908920 11:65314097 12:89727441 15:45120166 15:67361774 16:51464595 17:58890591 19:39181369 1:19792553 20:33449691 2:11353927 2:211652327 3:125148287 4:109703549 5:176790807 6:131869914 6:6972593 7:77567778 9:119324929 10:69965177 11:65493098 13:110391771 15:45153405 15:67452733 16:51754991 17:59212911 19:39254992 1:199185297 20:33704888 2:113967075 2:211661935 3:125861674 4:115498457 5:176813404 6:131874031 6:7120457 8:10096128 9:119327494 10:70120252 11:65493112 13:110878639 15:45274530 15:67535440 16:51763193 17:59241768 19:3952001 1:201016296 20:33763764 2:11531135 2:211698301 3:125906237 4:128193674 5:176904521 6:131893052 6:7197346 8:10224998 9:119355851 10:70240115 11:65551710 13:111062324 15:45360648 15:70391638 16:51776945 17:59246512 19:40800881 1:202003987 20:33823832 2:119178952 2:211723745 3:125909525 4:129522518 5:176922425 6:133487440 6:7275121 8:102683600 9:128087539 10:70400510 11:65689304 13:25255503 15:45364892 15:74124543 16:53191470 17:59419235 19:41353107 1:204306462 20:33859244 2:120493818 2:211820610 3:12842932 4:143822353 5:34504277 6:133612992 6:90118764 8:103651528 9:129858518 10:75016365 11:68859683 13:27753936 15:45364899 15:74470997 16:53516824 17:59424596 19:41407874 1:205542874 20:33986549 2:120936492 2:211872518 3:129300291 4:144043336 5:34535584 6:133849789 6:90317143 8:10640755 9:130746349 10:75558867 11:68879915 13:32397184 15:45381998 15:74503222 16:54284055 17:59437371 19:4502282 1:207239175 20:39958849 2:12105443 2:212258767 3:132184526 4:144069929 5:34723912 6:133854359 7:101706691 8:110107825 9:133504909 10:76337869 11:68886460 13:42749192 15:45417596 15:75027880 16:68317636 17:59450105 19:45392254 1:208028930 20:42738911 2:121310269 2:213130540 3:132421998 4:144355290 5:39337370 6:133892991 7:1018968 8:11495702 9:136146597 10:79252446 11:68957110 13:48643498 15:45425652 15:75333494 16:69599495 17:59459725 19:46183031 1:211422750 20:42815795 2:121935057 2:214012225 3:132436967 4:148039045 5:39351604 6:133916421 7:101902605 8:11593504 9:136931778 10:802272 11:69188078 13:50284028 15:45428712 15:75450277 16:69763280 17:59464100 19:49195411 1:212402889 20:43034016 2:121996932 2:217574414 3:134059150 4:23724229 5:39380965 6:133923890 7:101936555 8:11703420 9:139107879 10:82122793 11:69231796 13:50655989 15:45435823 15:75608382 16:71745518 17:59471686 19:49215302 1:2141866 20:52712127 2:122046743 2:217671349 3:134369420 4:23737865 5:39384018 6:133924416 7:113362799 8:11845417 9:140085182 10:82199415 11:69251852 13:51140911 15:45450015 15:75878956 16:71972060 17:59491384 19:49217305 1:214744893 20:52714706 2:135357705 2:217697519 3:135934711 4:23813109 5:39401384 6:134211282 7:1267820 8:120886486 9:140101687 10:88881176 11:69334714 13:51227415 15:45457838 15:76082858 16:73024276 17:59499517 19:49236465 1:217540734 20:52731402 2:137084209 2:217971021 3:135977040 4:23863409 5:39411049 6:154969450 7:127505755 8:120959434 9:140149248 10:899071 11:69990357 13:72345089 15:45474109 15:76102059 16:73068977 17:59517648 19:49560461 1:21820042 20:52737123 2:145681570 2:219286541 3:13731856 4:3074795 5:39430811 6:154983792 7:128576086 8:126500031 9:140358581 10:90232512 11:74381181 13:72371846 15:45488797 15:76124573 16:73085286 17:60597986 19:50138143 1:220991171 20:52737762 2:148803672 2:220299541 3:141093285 4:3443931 5:39434349 6:160093887 7:1286217 8:129918389 9:20554583 10:93790505 11:75470813 13:73575270 15:45494017 15:76151081 16:79722913 17:65373979 19:7295964 1:220999969 20:52739524 2:152225719 2:220300965 3:141561314 4:3449781 5:39450608 6:160302932 7:1286567 8:130377750 9:33125000 10:94762056 11:78043431 13:73716861 15:45495028 15:76193809 16:79785340 17:66439605 1:100808363 1:221001727 20:52774427 2:152378954 2:220358198 3:141644808 4:3454736 5:39588499 6:160378298 7:128708122 8:134332960 9:33127021 10:94839724 11:8039358 13:73778536 15:45508726 15:76235871 16:79843856 17:79612397 1:10691441 1:221136672 20:52776021 2:15768542 2:226754597 3:141654757 4:38662059 5:39617104 6:160397200 7:128740355 8:142217115 9:33956791 10:955051 11:958566 13:74116391 15:45510500 15:76304503 16:79942385 18:13484179 1:10707812 1:227081850 20:52783135 2:15782471 2:227006805 3:141666963 4:40420708 5:39624744 6:160499736 7:129406339 8:144890569 9:34065392 10:97276018 11:9767559 13:74730315 15:45582682 15:76326960 16:80045342 18:24393213 1:10730910 1:228551393 20:52787302 2:15814082 2:227205605 3:141703109 4:41642833 5:39747893 6:160537308 7:129589797 8:145018354 9:6353147 10:97830083 11:9909127 13:96059913 15:45592576 15:76379273 16:84255452 18:24447936 1:10733081 1:231697030 20:55990405 2:159694006 2:227277690 3:141708735 4:41658883 5:39990416 6:160552709 7:129636306 8:145504343 9:71157459 10:981843 12:112553032 13:96297821 15:45602731 15:76437983 16:84776178 18:42352453 1:10757199 1:23276385 20:56080049 2:159837242 2:227315015 3:141727630 4:41666008 5:40109713 6:160556642 7:129685597 8:21829948 9:71177110 10:99862371 12:115551631 14:100677812 15:45602970 15:76464380 16:84857378 18:42779107 1:10856692 1:235516145 20:56126962 2:159964552 2:230684296 3:141736258 4:52735258 5:40175615 6:160573575 7:1320824 8:22477807 9:71189353 11:111202432 12:115751903 14:100708315 15:45620147 15:76678692 16:88000503 18:46315420 1:109821797 1:23553225 20:56143169 2:161146583 2:232091757 3:141762853 4:54349317 5:40194626 6:160575366 7:1321183 8:23618463 9:71314936 11:111605215 12:120938200 14:100771531 15:45629507 15:76704878 16:88976663 18:46469664 1:110012289 1:23592651 20:57476890 2:164445099 2:233639309 3:141848046 4:5751066 5:40221244 6:160615437 7:1326861 8:23654713 9:71343194 11:118662028 12:121417306 14:101056280 15:45631076 15:79051705 16:89340504 18:53373610 1:112933892 1:236387072 20:60558635 2:16728610 2:234376177 3:141918940 4:5769368 5:423385 6:160636637 7:150690176 8:23718677 9:71375680 11:118798824 12:12210001 14:101202816 15:45632332 15:79057723 16:89632725 18:5585158 1:113248365 1:23699340 20:60833900 2:169963429 2:25994220 3:142216916 4:74486834 5:44186271 6:160644012 7:150785321 8:23720240 9:71417730 11:118978132 12:14966165 14:102758294 15:45683795 15:81156137 16:89708003 18:59360081 1:113258293 1:23718324 20:60902883 2:169992369 2:27177428 3:14233184 4:77019969 5:44812566 6:160669081 7:151371120 8:23745964 9:71434465 11:119306276 12:15307168 14:102994065 15:45701572 15:81165842 16:89717133 18:71935124 1:113337210 1:23833993 20:61030580 2:170004130 2:27319068 3:142809577 4:77050973 5:497341 6:160695773 7:151392009 8:23748420 9:71437322 11:121632740 12:15325031 14:104000183 15:45704596 15:82544393 16:89896005 18:77151867 1:115091266 1:243471192 20:62152519 2:170012199 2:27386799 3:152183512 4:77146405 5:501299 6:160722598 7:151402192 8:23812576 9:71441154 11:122509237 12:15368093 14:105259734 15:45719348 15:83440026 16:89985441 18:77156537 1:117021122 1:245575662 20:62326110 2:170092655 2:27598097 3:153902868 4:77211690 5:52751504 6:160852973 7:151408459 8:24042906 9:71470979 11:122606216 12:20373541 14:23907608 15:45723501 15:83464372 16:90050201 18:77157138 1:150276022 1:25241090 20:62353933 2:170104938 2:27735033 3:15697283 4:77242467 5:52791512 6:160877141 7:151413194 8:30280630 9:71562055 11:128349430 12:23875372 14:31721103 15:45739753 15:85191274 17:12137510 18:77160968 1:150341917 1:27188057 20:62445702 2:170203104 2:27783392 3:168875609 4:77243257 5:52808873 6:160964135 7:151414225 8:30407389 9:92269038 11:128351142 12:315390 14:35383219 15:45740624 15:90711982 17:1625892 18:77161840 1:150482255 1:27712608 20:62483910 2:170208975 2:27796159 3:169141880 4:77251326 5:52867670 6:161136294 7:151420858 8:32399290 9:95886051 11:128379479 12:31574269 14:38019415 15:45745803 15:98354472 17:17078017 18:77164766 1:150638903 1:28567075 20:62706105 2:175386507 2:280819 3:169155476 4:77291889 5:53032750 6:19381743 7:151422545 8:32409407 9:97729934 11:15885603 12:3232679 14:50849397 15:45751856 15:99205180 17:17358442 18:77171518 1:150868102 1:31844665 20:62911019 2:176302664 2:28277414 3:170076006 4:77298704 5:53192021 6:2039044 7:151436642 8:32435620)
for ChrNum in ${ChrNumList[@]};
do
	sed 's/\t/\n/g' ${ChrNum} | sed 's/,/\n/g' | awk -v c="${ChrNum}" '{if($1 != "") print c"\t"$1}' >> ../Meta_eGFR_GWAS_LeadSNP.NoMHC.PlinkClumping.p5e8.r20.1.1Mb.clumped.pairs.New.txt
done


###########################################################################
##### Step4: Extract genetic map for lead variants
awk 'NR>1{print $3}' Meta_eGFR_GWAS_LeadSNP.NoMHC.PlinkClumping.p5e8.r20.1.1Mb.clumped.formatted > Meta_eGFR_GWAS_LeadSNP.NoMHC.PlinkClumping.p5e8.r20.1.1Mb.clumped.formatted.SNP.txt
plink --file reduced.ALL.phase3_shapeit2_mvncall_integrated_v5.20130502.genotypes.EUR.rmdup \
--extract Meta_eGFR_GWAS_LeadSNP.NoMHC.PlinkClumping.p5e8.r20.1.1Mb.clumped.formatted.SNP.txt \
--recode \
--cm-map ./1000GP_Phase3/genetic_map_chr@_combined_b37.txt \
--out reduced.ALL.phase3_shapeit2_mvncall_integrated_v5.20130502.genotypes.EUR.rmdup.clumpedSNP


###########################################################################
##### Step4: Merge lead variants within 0.1cM
R
library(dplyr)
library(tidyr)
GWAS.clumped <- read.table("Meta_eGFR_GWAS_LeadSNP.NoMHC.PlinkClumping.p5e8.r20.1.1Mb.clumped.formatted", header=T, sep="\t")
Genetic_map <- read.table("reduced.ALL.phase3_shapeit2_mvncall_integrated_v5.20130502.genotypes.EUR.rmdup.clumpedSNP.map", header=F, sep="\t"); colnames(Genetic_map) <- c("CHR","SNP","cM","POS")
Clumped2SNP <- read.table("Meta_eGFR_GWAS_LeadSNP.NoMHC.PlinkClumping.p5e8.r20.1.1Mb.clumped.pairs.New.txt", header=F, sep="\t"); colnames(Clumped2SNP) <- c("Clumped","Inside_SNP")

GWAS.clumped.cM <- left_join(GWAS.clumped, Genetic_map, by = c("CHR" = "CHR","POS" = "POS"))
GWAS.clumped.cM.NA <- subset(GWAS.clumped.cM, is.na(cM))

#### Order
GWAS.clumped.cM.ordered <- GWAS.clumped.cM[with(GWAS.clumped.cM, order(CHR, POS)), ]
GWAS.clumped.cM.ordered$Merged <- NA
IndepedentLoci = 1
GWAS.clumped.cM.ordered[1,"Merged"] = IndepedentLoci
####
for (i in 2:1310){
  if(GWAS.clumped.cM.ordered[i,"CHR"] == GWAS.clumped.cM.ordered[i-1,"CHR"] & abs(GWAS.clumped.cM.ordered[i,"cM"] - GWAS.clumped.cM.ordered[i-1,"cM"]) < 0.1){
  	GWAS.clumped.cM.ordered[i,"Merged"] = IndepedentLoci
  }else {
    IndepedentLoci = IndepedentLoci + 1
  	GWAS.clumped.cM.ordered[i,"Merged"] = IndepedentLoci
  }
}

GWAS.clumped.cM.ordered.Top1 <- GWAS.clumped.cM.ordered %>% group_by(Merged) %>% top_n(n = -1, wt = P) %>% as.data.frame

GWAS.clumped.cM.ordered.Top1 <- GWAS.clumped.cM.ordered.Top1[,c(1:4,9)]
GWAS.clumped.cM.ordered.New <- GWAS.clumped.cM.ordered[,c(7,9)]

GWAS.clumped.cM.ordered.Top1 <- left_join(GWAS.clumped.cM.ordered.Top1, GWAS.clumped.cM.ordered.New, by = c("Merged" = "Merged"))
colnames(GWAS.clumped.cM.ordered.Top1) <- c("IndexSNP_CHR","IndexSNP_POS","IndexSNP_ID","IndexSNP_P","Merged","SNP.cM")

GWAS.clumped.cM.ordered.Top1 <- left_join(GWAS.clumped.cM.ordered.Top1, Clumped2SNP, by = c("SNP.cM" = "Clumped"))
write.table(GWAS.clumped.cM.ordered.Top1,"GWAS.clumped.cM.ordered.Top1.txt", col.names=T, row.names = F, quote=F,sep="\t")


#### Assign closest lead SNPs to missing SNPs
#### Due to incomplete annotation of 1000 genome genotypes, some variants was missing from the clumped list
All.Sig <- read.table("Meta.eGFR.GWAS.CKDGen.UKB.MVP.PAGE.SUMMIT.2Study.autosome.MAF0.001.Sig5e8.NoMHC.txt", header=T, sep="\t")
dim(All.Sig)
# [1] 72711    17
All.Sig$SNP <- paste(All.Sig$CHR,All.Sig$POS, sep=":")
Meta_eGFR_GWAS_LeadSNP.NoMHC <- All.Sig[,c("SNP","P.value")]
Meta_eGFR_GWAS_LeadSNP.NoMHC.Not <- subset(Meta_eGFR_GWAS_LeadSNP.NoMHC, !(SNP %in% GWAS.clumped.cM.ordered.Top1$Inside_SNP))
write.table(Meta_eGFR_GWAS_LeadSNP.NoMHC.Not,"Meta_eGFR_GWAS_LeadSNP.NoMHC.Not.txt", col.names=T, row.names = F, quote=F,sep="\t")

awk 'NR>1{print "chr"$1"\t"$2-1"\t"$2"\t"$3}' GWAS.clumped.cM.ordered.Top1.txt | sort | uniq | sort -t $'\t' -k1,1 -k2,2n -V > GWAS.clumped.cM.ordered.Top1.bed
awk 'NR>1{print $1}' Meta_eGFR_GWAS_LeadSNP.NoMHC.Not.txt | awk -F':' '{print "chr"$1"\t"$2-1"\t"$2"\t"$0}' | sort -t $'\t' -k1,1 -k2,2n -V > Meta_eGFR_GWAS_LeadSNP.NoMHC.Not.bed
head -n 1 Meta_eGFR_GWAS_LeadSNP.NoMHC.Not.txt | awk '{print "chr12\t0\t1\ttmp"}' >> Meta_eGFR_GWAS_LeadSNP.NoMHC.Not.bed
head -n 1 Meta_eGFR_GWAS_LeadSNP.NoMHC.Not.txt | awk '{print "chr13\t0\t1\ttmp"}' >> Meta_eGFR_GWAS_LeadSNP.NoMHC.Not.bed
head -n 1 Meta_eGFR_GWAS_LeadSNP.NoMHC.Not.txt | awk '{print "chr18\t0\t1\ttmp"}' >> Meta_eGFR_GWAS_LeadSNP.NoMHC.Not.bed
head -n 1 Meta_eGFR_GWAS_LeadSNP.NoMHC.Not.txt | awk '{print "chr21\t0\t1\ttmp"}' >> Meta_eGFR_GWAS_LeadSNP.NoMHC.Not.bed
sort -t $'\t' -k1,1 -k2,2n -V Meta_eGFR_GWAS_LeadSNP.NoMHC.Not.bed > Meta_eGFR_GWAS_LeadSNP.NoMHC.Not.sorted.bed

bedtools closest -a Meta_eGFR_GWAS_LeadSNP.NoMHC.Not.sorted.bed \
-b GWAS.clumped.cM.ordered.Top1.bed -D b -t first > Meta_eGFR_GWAS_LeadSNP.NoMHC.Not.closet.IndexSNP.bed

awk 'NR>1{print $3"\t"$7}' GWAS.clumped.cM.ordered.Top1.txt > GWAS.clumped.cM.ordered.Top1.Final.txt
awk '{if($4 != "tmp") print $8"\t"$4}' Meta_eGFR_GWAS_LeadSNP.NoMHC.Not.closet.IndexSNP.bed >> GWAS.clumped.cM.ordered.Top1.Final.txt

head -n 1 GWAS.clumped.cM.ordered.Top1.txt | awk '{print $3"\t"$7}' > GWAS.clumped.cM.ordered.Top1.Final.Uniq.txt
sort GWAS.clumped.cM.ordered.Top1.Final.txt | uniq >> GWAS.clumped.cM.ordered.Top1.Final.Uniq.txt


#### Add detailed information for lead SNPs
R
library(dplyr)
library(tidyr)
setwd("/home/hongbol/Projects/2019_05_31_EPIC_Kidney_Normal_mQTL/12_GWAS/Metal_Harmonized/Metal_run/CKDGen_UKB_MVP_PAGE_SUMMIT/SNP_at2Studies/IndependentLoci")
GWAS.clumped.Final <- read.table("GWAS.clumped.cM.ordered.Top1.Final.Uniq.txt", header=T, sep="\t")
All.Sig <- read.table("Meta.eGFR.GWAS.CKDGen.UKB.MVP.PAGE.SUMMIT.2Study.autosome.MAF0.001.Sig5e8.NoMHC.txt", header=T, sep="\t")
All.Sig$SNP <- paste(All.Sig$CHR, All.Sig$POS,sep=":")

length(unique(GWAS.clumped.Final$Inside_SNP))
length(unique(All.Sig$SNP))
length(unique(All.Sig$MarkerName))

GWAS.clumped.Final <- left_join(GWAS.clumped.Final, All.Sig[,c("SNP","MarkerName")], by = c("IndexSNP_ID" = "SNP"))
GWAS.clumped.Final <- left_join(GWAS.clumped.Final, All.Sig[,c("SNP","MarkerName")], by = c("Inside_SNP" = "SNP"))
colnames(GWAS.clumped.Final) <- c("IndexSNP_ID","Inside_SNP","IndexSNP_RSID","Inside_RSID")
GWAS.clumped.Final <- GWAS.clumped.Final %>% separate(Inside_SNP, c("Inside_SNP_CHR", "Inside_SNP_LOC"))

write.table(GWAS.clumped.Final,"GWAS.clumped.Final.txt", col.names=T, row.names = F, quote=F,sep="\t")

####
All.Sig.Index <- subset(All.Sig, SNP %in% GWAS.clumped.Final$IndexSNP_ID)
GWAS.clumped.Final.Left <- GWAS.clumped.Final[,c("IndexSNP_RSID","Inside_SNP_LOC")] %>% group_by(IndexSNP_RSID) %>% top_n(n = -1, wt = Inside_SNP_LOC) %>% as.data.frame
GWAS.clumped.Final.Right <- GWAS.clumped.Final[,c("IndexSNP_RSID","Inside_SNP_LOC")] %>% group_by(IndexSNP_RSID) %>% top_n(n = 1, wt = Inside_SNP_LOC) %>% as.data.frame
GWAS.clumped.Final.List <- aggregate(GWAS.clumped.Final$Inside_RSID, list(GWAS.clumped.Final$IndexSNP_RSID), paste, collapse=",")

colnames(GWAS.clumped.Final.Left)[2] <- "Left.Sig.Loc"
colnames(GWAS.clumped.Final.Right)[2] <- "Right.Sig.Loc"
colnames(GWAS.clumped.Final.List) <- c("IndexSNP_RSID","SNPs_in_Locus")

All.Sig.Index <- left_join(All.Sig.Index, GWAS.clumped.Final.Left, by = c("MarkerName" = "IndexSNP_RSID"))
All.Sig.Index <- left_join(All.Sig.Index, GWAS.clumped.Final.Right, by = c("MarkerName" = "IndexSNP_RSID"))
All.Sig.Index <- left_join(All.Sig.Index, GWAS.clumped.Final.List, by = c("MarkerName" = "IndexSNP_RSID"))

write.table(All.Sig.Index,"Meta_eGFR_GWAS_LeadSNP.NoMHC.PlinkClumping.p5e8.r20.1.1Mb.clumped.Merged.Infor.txt ", col.names=T, row.names = F, quote=F,sep="\t")



###########################################################################
##### Step5: Assign closest gene for each independent loci
awk 'NR>1{print "chr"$1"\t"$2-1"\t"$2"\t"$5}' Meta_eGFR_GWAS_LeadSNP.NoMHC.PlinkClumping.p5e8.r20.1.1Mb.clumped.Merged.Infor.txt | sort -t $'\t' -k1,1 -k2,2n -V > Meta_eGFR_GWAS_LeadSNP.NoMHC.PlinkClumping.p5e8.r20.1.1Mb.clumped.Merged.Infor.bed
bedtools closest -a Meta_eGFR_GWAS_LeadSNP.NoMHC.PlinkClumping.p5e8.r20.1.1Mb.clumped.Merged.Infor.bed \
-b /home/hongbol/Genome_Annotation/Reference/gtf/hg19/CodingGene_gencode_v35lift37_hg19_ID_sorted.TSS.autosome.bed -D b -t first |\
awk '{print $4"\t"$10"\t"$7"\t"$14}' > Meta_eGFR_GWAS_LeadSNP.NoMHC.PlinkClumping.p5e8.r20.1.1Mb.clumped.Merged.Infor.closetGene.bed

### Add geneinfor
R
library(dplyr)
library(tidyr)
GWAS.clumped.cM.Final.Infor <- read.table("Meta_eGFR_GWAS_LeadSNP.NoMHC.PlinkClumping.p5e8.r20.1.1Mb.clumped.Merged.Infor.txt", header=T, sep="\t")
Gene <- read.table("Meta_eGFR_GWAS_LeadSNP.NoMHC.PlinkClumping.p5e8.r20.1.1Mb.clumped.Merged.Infor.closetGene.bed", header=F, sep="\t")
colnames(Gene) <- c("RSID","Cloest.Gene","Gene.TSS","Dis2TSS")

GWAS.clumped.cM.Final.Infor <- left_join(GWAS.clumped.cM.Final.Infor, Gene, by = c("MarkerName" = "RSID"))
write.table(GWAS.clumped.cM.Final.Infor,"Meta_eGFR_GWAS_LeadSNP.NoMHC.PlinkClumping.p5e8.r20.1.1Mb.clumped.Merged.Infor.txt", col.names=T, row.names = F, quote=F,sep="\t")




